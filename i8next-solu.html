<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多项目共享 i18next 实例解决方案</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.3.0/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #1a2a6c, #b21f1f);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.4rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .badges {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-header i {
            font-size: 1.8rem;
            color: #1a2a6c;
            background: #e6e9ff;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        h2 {
            font-size: 1.6rem;
            color: #1a2a6c;
        }
        
        h3 {
            font-size: 1.3rem;
            color: #b21f1f;
            margin: 20px 0 15px;
            padding-left: 10px;
            border-left: 4px solid #b21f1f;
        }
        
        p {
            margin-bottom: 15px;
            color: #444;
        }
        
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.95rem;
            position: relative;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #9a9a9a;
            font-size: 0.9rem;
        }
        
        .copy-btn {
            background: #444;
            border: none;
            color: #ccc;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .copy-btn:hover {
            background: #555;
            color: white;
        }
        
        .diagram {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .highlight {
            background: #fff9db;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 500;
            color: #d9480f;
        }
        
        .advantages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .advantage-card {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e5ff;
            transition: all 0.3s;
        }
        
        .advantage-card:hover {
            background: #edf0ff;
            transform: scale(1.02);
        }
        
        .advantage-card i {
            font-size: 2.5rem;
            color: #1a2a6c;
            margin-bottom: 15px;
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            background: #f0f4ff;
            border-top: 1px solid #dde4ff;
            color: #555;
        }
        
        .footer a {
            color: #1a2a6c;
            text-decoration: none;
            font-weight: 600;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-globe-americas"></i> 多项目共享 i18next 实例解决方案</h1>
            <p class="subtitle">实现跨项目、微前端架构下的国际化资源管理与实例共享</p>
            <div class="badges">
                <div class="badge"><i class="fab fa-react"></i> React 18+</div>
                <div class="badge"><i class="fas fa-bolt"></i> Vite 4+</div>
                <div class="badge"><i class="fas fa-project-diagram"></i> 微前端架构</div>
                <div class="badge"><i class="fas fa-language"></i> i18next</div>
            </div>
        </header>
        
        <div class="content">
            <!-- 架构设计 -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-sitemap"></i>
                    <h2>整体架构设计</h2>
                </div>
                
                <div class="diagram" id="architecture-diagram">
                    <!-- Mermaid diagram will be rendered here -->
                </div>
                
                <h3>架构说明</h3>
                <p>该解决方案基于智能上下文检测系统，允许多个项目共享同一个i18next实例，同时支持独立运行模式。</p>
                
                <p>核心组件：</p>
                <ul>
                    <li><span class="highlight">共享上下文检测器</span> - 自动检测可用的i18next实例</li>
                    <li><span class="highlight">全局实例注册表</span> - 管理多个项目注册的实例</li>
                    <li><span class="highlight">回退机制</span> - 确保在没有主应用时也能正常工作</li>
                    <li><span class="highlight">命名空间隔离</span> - 避免不同项目的翻译资源冲突</li>
                </ul>
            </div>
            
            <!-- 核心实现 -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-code"></i>
                    <h2>核心代码实现</h2>
                </div>
                
                <h3>智能上下文检测器</h3>
                <p>该模块负责检测可用的i18next实例，按照优先级选择：</p>
                <ol>
                    <li>直接上下文（I18nContext）</li>
                    <li>检测器上下文（I18nDetectorContext）</li>
                    <li>全局注册表中最近注册的实例</li>
                    <li>回退实例</li>
                </ol>
                
                <div class="code-block">
                    <div class="code-header">
                        <span>shared-i18n/src/context-detector.ts</span>
                        <button class="copy-btn">复制代码</button>
                    </div>
                    <pre><code>import { I18nContext, useTranslation } from 'react-i18next';
import { createContext, useContext, useState, useEffect } from 'react';

// 全局实例注册表
const i18nRegistry = new Map&lt;string, any>();
let fallbackI18nInstance: any = null;

export const I18nDetectorContext = createContext&lt;{
  instance: any;
  namespace: string;
} | null>(null);

export function useSmartI18n(ns?: string) {
  // 优先级检测
  const directContext = useContext(I18nContext);
  const detectorContext = useContext(I18nDetectorContext);
  const [globalInstance, setGlobalInstance] = useState&lt;any>(null);

  useEffect(() => {
    if (i18nRegistry.size > 0) {
      const instances = Array.from(i18nRegistry.values());
      setGlobalInstance(instances[instances.length - 1]);
    }
  }, []);

  // 确定最终使用的实例
  const finalInstance = directContext || 
                        detectorContext?.instance || 
                        globalInstance || 
                        fallbackI18nInstance;
  
  // 使用i18next的useTranslation hook
  const { t, ready } = useTranslation(ns, { i18n: finalInstance });
  
  return { t, ready, instance: finalInstance };
}

// 注册i18next实例
export function registerI18nInstance(instance: any, key: string) {
  i18nRegistry.set(key, instance);
  if (!fallbackI18nInstance) fallbackI18nInstance = instance;
}

// 创建回退实例
export function createFallbackI18n() {
  if (!fallbackI18nInstance) {
    const i18n = require('i18next').createInstance();
    i18n.init({
      lng: 'en',
      resources: { 
        en: { common: { fallback: 'Fallback text' } }
      }
    });
    fallbackI18nInstance = i18n;
  }
  return fallbackI18nInstance;
}</code></pre>
                </div>
            </div>
            
            <!-- 项目集成 -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cogs"></i>
                    <h2>项目集成方式</h2>
                </div>
                
                <h3>主应用集成 (项目A)</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>project-a/src/App.tsx</span>
                        <button class="copy-btn">复制代码</button>
                    </div>
                    <pre><code>import React from 'react';
import { I18nextProvider } from 'react-i18next';
import { registerI18nInstance } from 'shared-i18n';
import i18n from './i18n'; // 项目A的i18n配置
import FeatureB from 'project-b'; // 项目B的组件

// 注册实例到全局
registerI18nInstance(i18n, 'project-a');

function App() {
  return (
    &lt;I18nextProvider i18n={i18n}>
      &lt;div className="app">
        &lt;h1>项目A主应用&lt;/h1>
        &lt;FeatureB /> {/* 使用项目B的组件 */}
      &lt;/div>
    &lt;/I18nextProvider>
  );
}

export default App;</code></pre>
                </div>
                
                <h3>微前端集成</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>project-b/src/microfrontend.ts</span>
                        <button class="copy-btn">复制代码</button>
                    </div>
                    <pre><code>import React from 'react';
import ReactDOM from 'react-dom';
import { I18nDetectorContext } from 'shared-i18n';
import FeatureB from './components/FeatureB';

// 微前端挂载函数
export const mount = (container, i18nInstance) => {
  ReactDOM.render(
    &lt;I18nDetectorContext.Provider 
      value={{ 
        instance: i18nInstance,
        namespace: 'projectB' 
      }}
    >
      &lt;FeatureB />
    &lt;/I18nDetectorContext.Provider>,
    container
  );
};

// 卸载函数
export const unmount = (container) => {
  ReactDOM.unmountComponentAtNode(container);
};</code></pre>
                </div>
            </div>
            
            <!-- Vite配置 -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-tools"></i>
                    <h2>Vite配置详解</h2>
                </div>
                
                <h3>为什么需要特定Vite配置？</h3>
                <ul>
                    <li><span class="highlight">模块解析</span> - 处理多项目间的依赖关系</li>
                    <li><span class="highlight">版本控制</span> - 确保共享相同的依赖版本</li>
                    <li><span class="highlight">构建优化</span> - 减少最终包大小</li>
                    <li><span class="highlight">按需加载</span> - 支持动态加载语言资源</li>
                </ul>
                
                <h3>共享库配置 (shared-i18n)</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>shared-i18n/vite.config.ts</span>
                        <button class="copy-btn">复制代码</button>
                    </div>
                    <pre><code>import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import dts from 'vite-plugin-dts';
import path from 'path';

export default defineConfig({
  plugins: [
    react(),
    dts({ insertTypesEntry: true }), // 生成类型声明
  ],
  build: {
    lib: {
      entry: path.resolve(__dirname, 'src/index.ts'),
      name: 'SharedI18n',
      formats: ['es', 'umd'],
      fileName: (format) => `shared-i18n.${format}.js`,
    },
    rollupOptions: {
      // 外部化依赖
      external: ['react', 'react-dom', 'react-i18next', 'i18next'],
      output: {
        globals: {
          react: 'React',
          'react-dom': 'ReactDOM',
          'react-i18next': 'ReactI18next',
          i18next: 'i18next',
        },
      },
    },
  },
});</code></pre>
                </div>
            </div>
            
            <!-- 独立运行 -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-laptop-code"></i>
                    <h2>独立运行支持</h2>
                </div>
                
                <h3>项目B独立运行配置</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>project-b/src/standalone.tsx</span>
                        <button class="copy-btn">复制代码</button>
                    </div>
                    <pre><code>import React from 'react';
import ReactDOM from 'react-dom/client';
import { I18nextProvider } from 'react-i18next';
import { createFallbackI18n } from 'shared-i18n';
import FeatureB from './components/FeatureB';

// 仅在独立运行模式下执行
if (import.meta.env.MODE === 'standalone') {
  const rootElement = document.getElementById('root');
  if (rootElement) {
    const root = ReactDOM.createRoot(rootElement);
    
    // 创建回退实例
    const i18n = createFallbackI18n();
    
    // 添加项目B的资源
    i18n.addResourceBundle('en', 'projectB', {
      title: 'Project B Standalone',
      description: 'Running in standalone mode'
    });
    
    // 渲染应用
    root.render(
      &lt;React.StrictMode>
        &lt;I18nextProvider i18n={i18n}>
          &lt;FeatureB />
        &lt;/I18nextProvider>
      &lt;/React.StrictMode>
    );
  }
}</code></pre>
                </div>
                
                <h3>独立运行脚本</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>project-b/package.json</span>
                        <button class="copy-btn">复制代码</button>
                    </div>
                    <pre><code>{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "dev:standalone": "vite --mode standalone",
    "build:standalone": "vite build --mode standalone"
  },
  "peerDependencies": {
    "react": "^18.0.0",
    "react-dom": "^18.0.0",
    "react-i18next": "^12.0.0",
    "i18next": "^22.0.0",
    "shared-i18n": "file:../shared-i18n"
  }
}</code></pre>
                </div>
            </div>
            
            <!-- 优势总结 -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-star"></i>
                    <h2>方案优势总结</h2>
                </div>
                
                <div class="advantages">
                    <div class="advantage-card">
                        <i class="fas fa-brain"></i>
                        <h3>智能实例检测</h3>
                        <p>自动寻找可用的i18next实例，多级回退机制确保始终可用</p>
                    </div>
                    
                    <div class="advantage-card">
                        <i class="fas fa-puzzle-piece"></i>
                        <h3>灵活集成</h3>
                        <p>支持主应用、微前端、依赖包等多种集成方式</p>
                    </div>
                    
                    <div class="advantage-card">
                        <i class="fas fa-rocket"></i>
                        <h3>零配置使用</h3>
                        <p>项目只需导入useSmartI18n即可使用，无需复杂配置</p>
                    </div>
                    
                    <div class="advantage-card">
                        <i class="fas fa-compress-arrows-alt"></i>
                        <h3>优化构建</h3>
                        <p>依赖外部化减少包大小，支持按需加载语言资源</p>
                    </div>
                    
                    <div class="advantage-card">
                        <i class="fas fa-sync-alt"></i>
                        <h3>无缝迁移</h3>
                        <p>现有项目只需添加少量代码即可迁移，支持渐进式迁移</p>
                    </div>
                    
                    <div class="advantage-card">
                        <i class="fas fa-code-branch"></i>
                        <h3>独立运行</h3>
                        <p>每个项目都可独立运行，便于开发和测试</p>
                    </div>
                </div>
                
                <h3>构建与部署流程</h3>
                <div class="diagram" id="build-diagram">
                    <!-- Mermaid diagram will be rendered here -->
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2023 多项目共享i18next实例解决方案 | 使用技术: React, Vite, i18next, 微前端架构</p>
            <p>实际应用中，建议将共享库发布到私有npm仓库，并使用CDN托管语言资源</p>
        </div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: { 
                useMaxWidth: false,
                htmlLabels: true 
            }
        });
        
        // Architecture diagram
        const architectureDiagram = `graph TD
            A[项目A - 主应用] -->|初始化| I[i18n实例]
            C[项目C] -->|初始化| I2[i18n实例]
            D[项目D] -->|初始化| I3[i18n实例]
            B[项目B - 共享组件库] -->|智能检测| I
            B -->|智能检测| I2
            B -->|智能检测| I3
            B -->|独立运行| IB[自有实例]
            
            subgraph 共享核心
                I --> RC[上下文检测系统]
                I2 --> RC
                I3 --> RC
                IB --> RC
            end`;
        
        // Build process diagram
        const buildDiagram = `graph LR
            S[构建 shared-i18n] --> B[构建 project-b]
            B --> A[构建 project-a]
            B --> C[构建 project-c]
            B --> D[构建 project-d]`;
        
        // Render diagrams
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('architecture-diagram').innerHTML = architectureDiagram;
            document.getElementById('build-diagram').innerHTML = buildDiagram;
            mermaid.init(undefined, '.diagram');
        });
        
        // Copy button functionality
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', function() {
                const codeBlock = this.closest('.code-block').querySelector('code');
                const textArea = document.createElement('textarea');
                textArea.value = codeBlock.textContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // Visual feedback
                const originalText = this.textContent;
                this.textContent = '✓ 已复制';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            });
        });
    </script>
</body>
</html>